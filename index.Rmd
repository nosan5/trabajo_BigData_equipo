---
title: <center><FONT COLOR="FF4D00">ANÁLISIS SOBRE LA COVID-19</FONT></center>
author: "Miembros del grupo: \n\n\n **Ignacio Montava** (monpeig@alumni.uv.es), \n\n **Andreu Esparza** (anesimar@alumni.uv.es) \n\n **Noelia Sánchez** (nosan5@alumni.uv.es) \n\n Universitat de València"
date: " `r format(Sys.time(), '%d-%m-%Y')`"
output:
  html_document: 
    self_contained: yes
    code_download: true
    code_folding: show
    theme: united
    highlight: pygments
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    df_print: kable
editor_options: 
  chunk_output_type: console
---

```{r packages-setup, include = FALSE}
library(tidyverse)
# remotes::install_github("rlesur/klippy")
library(klippy) 
library(knitr)
```

```{r chunk-setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, 
                      #results = "hold",
                      cache = FALSE, cache.path = "/caches/", comment = "#>",
                      #fig.width = 7, #fig.height= 7,   
                      #out.width = 7, out.height = 7,
                      collapse = TRUE,  fig.show = "hold",
                      fig.asp = 7/9, out.width = "60%", fig.align = "center")
#- para mejorar los gráficos, bueno en realidad para que se vean igual en distintos SO
#- https://www.jumpingrivers.com/blog/r-knitr-markdown-png-pdf-graphics/
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
```

```{r options-setup, include = FALSE}
options(scipen = 999) #- para quitar la notación científica
options("yaml.eval.expr" = TRUE) #- https://github.com/viking/r-yaml/issues/47  (lo puse x el pb con el warning) En realidad creo que mejor sería ponerlo en RProfile
```


```{r klippy, echo = FALSE}
klippy::klippy(position = c("top", "right")) #- remotes::install_github("rlesur/klippy")
```

<div style="text-align: justify"><div/>
-----------------

<FONT COLOR="Blue">Trabajo  elaborado para la asignatura "Programación y manejo de datos en la era del Big Data" de la Universitat de València durante el curso 2020-2021. La página web de la asignatura puede verse aquí: <https://perezp44.github.io/intro-ds-20-21-web/>. Los trabajos de mis compañeros de curso pueden verse [aquí](https://perezp44.github.io/intro-ds-20-21-web/07-trabajos.html)</FONT>

---------------
**NO ESTÁ ACABADO!**

## 1. Introducción 


En la asignatura de "Programación y manejo de datos en la era del Big Data" [^1] tenemos que hacer un trabajo de tema libre, por lo que nos parecia interesante hacerlo de un tema que nos afecta a todos, como es **la evolución de la pandemia de la Covid-19** 

Por ello, hemos buscado diferentes conjuntos de datos con los que poder hacer el análisis. Y así, mostrar de una forma más visual y sencilla diferentes cuestiones que nos pueden surgir al pensar en la Covid-19. Como por ejemplo, que incidencia de contagios ha habido dependiendo de la província o CCAA, donde se han hecho más pruebas pcr o test de ac o que paises han controlado mejor o peor la pandemía, entre otras cuestioenes. 

## 2. Contexto mundial de la Covid-19 
<br>

#### <FONT COLOR="FF4D00">**ORIGEN DEL COVID-19**</FONT>

La Covid-19 es una enfermedad **infecciosa** causada por un coronavirus recientemente descubierto. 

Tuvo su origen en la ciudad de Wuhan, en China. Y el **primer caso** diagnosticado fue el 17 de noviembre de 2019. Todo y que se ha expandido rapidamente por todo el mundo.

<br>

#### <FONT COLOR="FF4D00">**¿QUÉ ES EL CORONAVIRUS**</FONT>

Los coronavirus son una **serie de virus** llamados así por su forma. Estos organismos no son nuevos, ya que conviven con el ser humano desde siempre. Además, hay muchos tipos de ellos, tanto en animales como en seres humanos.

Sin embargo, el análisis comparativo de esta enfermedad determinó que el SARS-CoV-2 era lo suficientemente distinto de los otros coronavirus de gravedad detectados en humanos (SARS y MERS) como para que este fuera consdierado una nueva enfermedad, recibiendo el nombre de **Covid-19.**


<center><img src="imagenes/covid.jpg" width="350px" /></center>

<br>

#### <FONT COLOR="FF4D00">**¿CÓMO SE PROPAGA EL COVID-19?**</FONT>

El virus que causa la Covid-19 se transmite principalmente a través de la gotículas generadas cuando una persona infectada **tose, estornuda o espira.** [^2]

Estas gotículas son demasiado pesadas para permanecer suspendidas en el aire y caen rapidamente sobre el suelo y/o las superfícies, conviertiendose estas en otra forma  posible de contagio. 

## 3. Datos utilizados para el trabajo. {.tabset}

### <FONT COLOR="FF4D00">**Datos**</FONT>

Obtener los datos es fundamental para poder hacer el análisis.

Por ello, para el presente trabajo utilizaremos los datos que hemos extraido en diferentes páginas web, referenciadas al final del informe (en [Referencias]), y que hemos modificado para poder hacer este análisis.

De manera que, los datos modificado aparecen en la pestaña Tidy. Estos corresponden a aquellos que contienen información sobre los contagiados, recuperados y fallecidos a nivel mundial, estatal y autonómico. 

Así como otras cifras, sobre las diferentes pruebas realizadas (PCR's y Test rápidos), la saturación del sistema santiario español y algunos efectos económicos de la pandemía. 


### <FONT COLOR="FF4D00">**Tidy**</FONT>

La finalidad de este apartado es poner los código que hemos utilizado para "limpiar" los datos y a partir de los cuales hemos podido hacer gráficos, mapas, tablas...

```{r}
#TIDY PARA EL "MUNDO".

library(rio)
library(tidyverse)

url_mundo <- "https://raw.githubusercontent.com/datasets/covid-19/master/data/time-series-19-covid-combined.csv"

df_mundo <- readr::read_csv(url_mundo)

df_mundo <- df_mundo %>% select(-"Province/State") %>%
            separate(Date, c("Año","Mes","Dia"), sep = "-")

df_mundo <- df_mundo  %>%
            relocate("Country/Region", .before=Año) %>%
            relocate(Año, .before=Confirmed)

df_mundo <- df_mundo %>%
            relocate(Mes, .after=Dia)

#A fecha del 01/12:

df_mundo_12 <- df_mundo %>% filter(Mes == "12" & Dia == "01")
df_mundo_12 <- df_mundo_12 %>% select(-Deaths)

#Para ver que hay países que se repiten y habrá que sumar todos los que se repiten:

df <- df_mundo_12 %>% group_by(`Country/Region`) %>% summarise(N = n())
#Países que se repiten: Australia, Canada, China, Denmark, France, Netherlands, United Kingdom.

df_b <- df_mundo_12 %>% filter(!(`Country/Region` %in% c("Australia", "Canada", "China", "Denmark", "France", "Netherlands", "United Kingdom")))


#Para Australia:
df_A <- df_mundo_12 %>% filter(`Country/Region` %in% "Australia")
df_cA <- df_A %>% mutate(Confirmed = sum(Confirmed))
df_cA <- df_cA %>% mutate(Recovered = sum(Recovered))
df_cA <- df_cA %>% slice(1)

#Para China:
df_C <- df_mundo_12 %>% filter(`Country/Region` %in% "China")
df_c <- df_C %>% mutate(Confirmed = sum(Confirmed))
df_c <- df_c %>% mutate(Recovered = sum(Recovered))
df_c <- df_c %>% slice(1)

#Para Denmark:
df_D <- df_mundo_12 %>% filter(`Country/Region` %in% "Denmark")
df_d <- df_D %>% mutate(Confirmed = sum(Confirmed))
df_d <- df_d %>% mutate(Recovered = sum(Recovered))
df_d <- df_d %>% slice(1)

#Para France:
df_F <- df_mundo_12 %>% filter(`Country/Region` %in% "France")
df_f <- df_F %>% mutate(Confirmed = sum(Confirmed))
df_f <- df_f %>% mutate(Recovered = sum(Recovered))
df_f <- df_f %>% slice(1)

#Para Netherlands:
df_N <- df_mundo_12 %>% filter(`Country/Region` %in% "Denmark")
df_n <- df_N %>% mutate(Confirmed = sum(Confirmed))
df_n <- df_n %>% mutate(Recovered = sum(Recovered))
df_n <- df_n %>% slice(1)

#Para United Kingdom:
df_U <- df_mundo_12 %>% filter(`Country/Region` %in% "Denmark")
df_u <- df_U %>% mutate(Confirmed = sum(Confirmed))
df_u <- df_u %>% mutate(Recovered = sum(Recovered))
df_u <- df_u %>% slice(1)


#Ahora tengo que juntar las tablas:
tabla <- bind_rows(df_b, df_u, df_n, df_f, df_d, df_c, df_cA)
```

```{r}
#Gráficos de la evolución del Covid-19
library(tidyverse)
url_mundo <- "https://raw.githubusercontent.com/datasets/covid-19/master/data/time-series-19-covid-combined.csv"

df_mundo <- readr::read_csv(url_mundo)

df_mundo <- df_mundo %>% select(-"Province/State") %>%
            separate(Date, c("Año","Mes","Dia"), sep = "-")

df_mundo <- df_mundo  %>%
            relocate("Country/Region", .before=Año) %>%
            relocate(Año, .before=Confirmed)

df_mundo <- df_mundo %>%
            relocate(Mes, .after=Dia)
```

```{r}
#Estos datos muestran el número de muertes diarias en el mundo, los hemos arreglado para poder hacer un facet_wrap con los diferentes meses y la evolución de estos según los dias. 
library(tidyverse)

#Para la tabla de muertes_dia hacemos, separamos por día y mes. Y filtrar las fechas hasta des de las primeras disponibles hasta el 31 de octubre.

library(lubridate)

muertes_dia <- rio::import(here::here("datos", "muertes_dia.xlsx"))

muertes_dia <- muertes_dia %>% mutate(Dia= day(Date)) %>% mutate(Mes= month(Date))  %>%
filter(!Mes == "11")  %>% select(!Date)

muertes_dia <- muertes_dia %>% mutate(Mes = case_when(
  Mes == 1 ~ "Enero",
  Mes == 2 ~ "Febrero",
  Mes == 3 ~ "Marzo",
  Mes == 4 ~ "Abril",
  Mes == 5 ~ "Mayo",
  Mes == 6 ~ "Junio",
  Mes == 7 ~ "Julio",
  Mes == 8 ~ "Agosto",
  Mes == 9 ~ "Septiembre",
  Mes == 10 ~ "Octubre",
))

muertes_dia$facet = factor(muertes_dia$Mes, levels = c("Enero","Febrero","Marzo", "Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre"))
```

```{r}
#Datos_CCAA
urla <-"https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_ingresos_camas_convencionales_uci.csv"
aaa <- rio::import(urla)

#Hay que tener en cuenta que la variable % Camas Ocupadas UCI Covid no tiene datos hasta el 21-09-2020 por lo tanto para analizar la segunda OLA si que nos sirve pero no para la primera
library(tidyverse)


datos_CCAA <- aaa %>%
  separate(Fecha, c("Año","Mes","Dia"), sep = "-") %>%
  select(-CCAA) %>% mutate(CCAA = case_when(
  cod_ine == 0 ~ "España",
  cod_ine == 1 ~ "Andalucia",
  cod_ine == 2 ~ "Aragon",
  cod_ine == 3 ~ "Asturias",
  cod_ine == 4 ~ "Islas Baleares",
  cod_ine == 5 ~ "Canarias",
  cod_ine == 6 ~ "Cantabria",
  cod_ine == 7 ~ "Castilla Leon",
  cod_ine == 8 ~ "Castilla La Mancha",
  cod_ine == 9 ~ "Cataluña",
  cod_ine == 10 ~ "Com.Valenciana",
  cod_ine == 11 ~ "Extremadura",
  cod_ine == 12 ~ "Galicia",
  cod_ine == 13 ~ "Madrid",
  cod_ine == 14 ~ "Murcia",
  cod_ine == 15 ~ "Navarra",
  cod_ine == 16 ~ "Pais Vasco",
  cod_ine == 17 ~ "La Rioja",
  cod_ine == 18 ~ "Ceuta",
  cod_ine == 19 ~ "Melilla",
)) %>% relocate(CCAA, .after=cod_ine)

datos_CCAA <- datos_CCAA %>% rename("Ingresos Ult.24h" = "Ingresos COVID Ãºltimas 24 h") %>% rename("Altas Ult24h" = "Altas COVID Ãºltimas 24 h")
```


##  4. Estudio sobre los **Datos del MUNDO**

### 4.1 Preguntas y respuestas de la situación actual.

```{r}
df <- rio::import(here::here("datos", "tabla_mundo.csv"))

#Con esto podemos hacer unas tablas.

dfmax1 <- df %>% slice_max(Confirmed, n=1) #Estados Unidos es el país con más contagios.

dfmax2 <- df %>% slice_max(Recovered, n=1) #El máximo de recuperados está en India.

df_min1 <- df %>% slice_min(Confirmed, n=1) #El país con menos contagios es Vanuatu (es un país Oceania)

#https://www.europapress.es/internacional/noticia-isla-vanuatu-confirma-primer-caso-coronavirus-20201111101020.html <- Podemos poner esta notícia !!

#TABLA PARA EL PAÍS CON MENOS CONATGIOS.

Imagen <- "http://banderasmundo.es/wp-content/uploads/2017/09/vanuatu.png"

df_min1 <- df_min1 %>% add_column(Imagen)
df_min1 <- df_min1 %>% select(-c(Dia, Mes, Año))

library(gt)
Tabla_Pmencotag <- df_min1 %>% gt()

Tabla_Pmencotag <- Tabla_Pmencotag %>%
                   tab_header(title = md("**País con menos contagios de Covid-19**"),subtitle = md("A fecha: 1/12/2020"))

Tabla_Pmencotag <- Tabla_Pmencotag %>%
                tab_options(heading.background.color = "coral") %>% tab_options(heading.title.font.size = 15, heading.subtitle.font.size = 13,  column_labels.font.weight =  "bold")


Tabla_Pmencotag <- Tabla_Pmencotag  %>%
  gt::text_transform(locations = cells_body(columns = vars(Imagen)), fn = function(x) {gt::web_image(x, height = 50)}) %>%  cols_align(
    align = "center")


#TABLA PARA EL PAÍS CON MÁS CONTAGIOS:


ImagenUS <- "https://upload.wikimedia.org/wikipedia/commons/a/a4/Flag_of_the_United_States.svg"

dfmax1 <- dfmax1 %>% add_column(ImagenUS)
dfmax1 <- dfmax1 %>% select(-c(Dia, Mes, Año))

library(gt)
Tabla_Pmascotag <- dfmax1 %>% gt()

Tabla_Pmascotag <- Tabla_Pmascotag %>%
                   tab_header(title = md("**País con más contagios de Covid-19**"),subtitle = md("A fecha: 1/12/2020"))

Tabla_Pmascotag <- Tabla_Pmascotag %>%
                tab_options(heading.background.color = "coral") %>% tab_options(heading.title.font.size = 15, heading.subtitle.font.size = 13,  column_labels.font.weight =  "bold")


Tabla_Pmascotag <- Tabla_Pmascotag  %>%
  gt::text_transform(locations = cells_body(columns = vars(ImagenUS)), fn = function(x) {gt::web_image(x, height = 50)}) %>%  cols_align(
    align = "center")

#PAÍS CON MÁS RECUPERADOS DE COVID-19

ImagenI <- "https://www.banderas-mundo.es/data/flags/w580/in.png"

dfmax2 <- dfmax2 %>% add_column(ImagenI)
dfmax2 <- dfmax2 %>% select(-c(Dia, Mes, Año))


library(gt)
Tabla_Pmasrecu <- dfmax2 %>% gt()


Tabla_Pmasrecu <- Tabla_Pmasrecu %>%
                   tab_header(title = md("**País con más recuperados de Covid-19**"),subtitle = md("A fecha: 1/12/2020"))

Tabla_Pmasrecu <- Tabla_Pmasrecu %>%
                tab_options(heading.background.color = "coral") %>% tab_options(heading.title.font.size = 15, heading.subtitle.font.size = 13,  column_labels.font.weight =  "bold")


Tabla_Pmasrecu <- Tabla_Pmasrecu  %>%
  gt::text_transform(locations = cells_body(columns = vars(ImagenI)), fn = function(x) {gt::web_image(x, height = 50)}) %>%  cols_align(
    align = "center")
```


<br>
<center><FONT COLOR="Blue">**¿CUÁL ES EL PAÍS CON MÁS PERSONAS CONTAGIADAS?**</FONT></center>
 
<br>
```{r echo = FALSE, eval = TRUE}
Tabla_Pmascotag
```


<br>
<center><FONT COLOR="Blue">**¿CUÁL ES EL PAÍS CON MENOS CONTAGIOS?**</FONT></center>

<br>
```{r echo = FALSE, eval = TRUE}
Tabla_Pmencotag
```


<br>
<center><FONT COLOR="Blue">**¿EN QUÉ PAÍS HAY MÁS PERSONAS RECUPERADAS?**</FONT></center>
<br>
```{r echo = FALSE, eval = TRUE}
Tabla_Pmasrecu
```




### 4.2 Los 10 países con más casos de Coronavirus, ¿Cuáles son?

```{r echo = FALSE, eval= TRUE}
#Gráfico con los 10 países que más casos de coronavirus presentan.
#Lo he sacado a partir de aquí: https://rpubs.com/JonathanRzezak/652633 !!!!

#remotes::install_github("kjhealy/covdata@main")

library(covdata)
library(tidyverse)
library(lubridate)
library(gganimate)
library(gifski)
library(RColorBrewer)

#install.packages("Cairo")
library(Cairo)

covid <- covnat %>%
  group_by(date) %>%
  arrange(date, desc(cu_cases)) %>%
  mutate(ranking = row_number()) %>%
  filter(ranking <= 10)

#unique(covid$cname) #Esto nos sirve para ver la variable que muestra el nombre de las regiones del df covid.

#De esta manera ha cambiado algunos nombres de la fila cname, también se podía haber hecho con la función case_when.

covid$cname <- gsub("Taiwan, Province of China", "Taiwan", covid$cname)
covid$cname <- gsub("Iran, Islamic Republic of", "Iran", covid$cname)
covid$cname <- gsub("Russian Federation", "Russia", covid$cname)
covid$cname <- gsub("Korea, Republic of", "South Korea", covid$cname)
covid$cname <- gsub("United Arab Emirates", "UAE", covid$cname)

#cu_cases son los casos acumulados.

#install.packages("RColorBrewer")
nb.cols <- 50
mycolors <- colorRampPalette(brewer.pal(12, "Paired"))(nb.cols)
```

```{r}
a <- ggplot(covid)+
  geom_col(aes(ranking,cu_cases,fill=cname))+
  scale_fill_manual(values=mycolors)+
  geom_text(aes(ranking,cu_cases,label=as.factor(cu_cases)),hjust=-0.1,size=5)+
  geom_text(aes(ranking, y=0 , label = cname), hjust=1.1,size=5) +
  geom_text(aes(x=10, y=max(cu_cases) , label = as.factor(date)), vjust = 0, hjust=1, alpha = 0.1,  col = "black", size = 20)+
  labs(title = "Evolución de los casos positivos de Covid-19 en el mundo",
       subtitle = "Datos de la Universidad Johns Hopkins",
       x=NULL,
       y=NULL)+
  coord_flip(clip = "off")+
  scale_x_reverse()+
  theme_minimal()+
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(hjust = 0, size=20,face="bold"),
        plot.subtitle = element_text(hjust = 0, size=12, face="italic"),
        plot.margin = margin(1, 4, 1, 3, "cm"))+
  transition_states(date,transition_length = 1,state_length = 0,wrap = FALSE)
```

```{r out.width="100%"}
 animate(a,
        nframes = 800,
        fps = 24,
        end_pause = 200,
        width = 1000,
        height = 600,
        type = "cairo")
```

### 4.3 Evolución de los contagios (a nivel mundial)

Para poder entender como ha sido la propagación del virus a nivel mundial nos parecia interesante analizar diferentes países que no fueran parecidos entre si. Para ello elegimos estos países - **Estados Unidos, Nigeria, Portugal y Japón** - e hicimos un gráfico donde mostramos la evolución de los casos registrados diariamente.  

```{r US}
#Gráfico para US:
df_mundoUS<- df_mundo %>% filter(`Country/Region` == "US") %>% select(-c(Recovered, Deaths))

df_mundoUSS <- df_mundoUS %>% summarise(dif = diff(Confirmed))

dfUS <- df_mundoUS %>% select(`Country/Region`,Dia, Mes)
dfUS <- dfUS %>% slice(-1)
US <- bind_cols(dfUS, df_mundoUSS)

US <- US %>% mutate(ranking = row_number())

graficoUS <- ggplot(US, aes(ranking, dif, color = Mes)) + geom_line() + labs(title = "EEUU",  x = NULL, y = "Nº casos al día") +  theme_bw() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())  +  theme(plot.title = element_text(hjust = 0.5)) +  theme(legend.position = "none")

#Ibamos ha hacerlo también de Australia, pero no lo he hecho porque el número de casos es bastante bajo y la diferencia entre un día y otro sale negativa. (Por lo que el gráfico no se ve bien)

#Mismo proceso para Nigeria, Japón y Portugal
#Por tanto, pongo el código para que no se vea. (echo=FALSE)
```


```{r Nigeria,  echo=FALSE, eval=TRUE}

#Para Nigeria:

df_mundoN<- df_mundo %>% filter(`Country/Region` == "Nigeria") %>% select(-c(Recovered, Deaths))

df_mundoNN <- df_mundoN %>% summarise(dif = diff(Confirmed))

dfN <- df_mundoN %>% select(`Country/Region`,Dia, Mes)
dfN <- dfN %>% slice(-1)
N <- bind_cols(dfN, df_mundoNN)

N <- N %>% mutate(ranking = row_number())

graficoN <- ggplot(N, aes(ranking, dif, color = Mes)) + geom_line() + labs(title = "Nigeria", x = NULL, y = "Nº casos al día") +  theme_bw() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())  +  theme(plot.title = element_text(hjust = 0.5)) +  theme(legend.position = "none")

```



```{r Japón, echo=FALSE, eval=TRUE}

#Para Japón

df_mundoJ<- df_mundo %>% filter(`Country/Region` == "Japan") %>% select(-c(Recovered, Deaths))

df_mundoJJ <- df_mundoJ %>% summarise(dif = diff(Confirmed))

dfJ <- df_mundoJ %>% select(`Country/Region`,Dia, Mes)
dfJ <- dfJ %>% slice(-1)
J <- bind_cols(dfJ, df_mundoJJ)

J <- J %>% mutate(ranking = row_number())

graficoJ <- ggplot(J, aes(ranking, dif, color = Mes)) + geom_line() + labs(title = "Japón",  x = NULL, y = "Nº casos al día") +  theme_bw() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())  +  theme(plot.title = element_text(hjust = 0.5)) + theme(legend.position = "none")
```

```{r Portugal, echo = FALSE,eval=TRUE}
#Para Portugal

df_mundoP<- df_mundo %>% filter(`Country/Region` == "Portugal") %>% select(-c(Recovered, Deaths))

df_mundoPP <- df_mundoP %>% summarise(dif = diff(Confirmed))

dfP <- df_mundoP %>% select(`Country/Region`,Dia, Mes)
dfP <- dfP %>% slice(-1)
P <- bind_cols(dfP, df_mundoPP)

P <- P %>% mutate(ranking = row_number())

graficoP <- ggplot(P, aes(ranking, dif, color = Mes)) + geom_line() + labs(title = "Portugal",  x = NULL, y = "Nº casos al día") +  theme_bw() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())  +  theme(plot.title = element_text(hjust = 0.5))+  theme(legend.position = "none")
```


```{r echo=FALSE, eval = TRUE,  out.width="90%" }
library(patchwork)
(graficoUS + graficoP) / (graficoJ + graficoN)
```
Cabe tener en cuenta que los colores muestran los diferentes meses, empezando en Enero y acabando en Noviembre.

A la vista del gráfico observamos que la evolución en los distintos países es muy diferente. En <FONT COLOR="FF4D00">**PORTUGAL**</FONT>, al **principio de la pandemia se muestra un aumento en la curva, aunque es muy poco pronunciado** y **seguidamente los casos bajan y se mantienen en valores muy bajos durante un período de tiempo (meses) largo** hasta que empieza la **segunda ola donde los casos se disparan teniendo su máximo en casi 8000 casos registrados en un solo dia**.

La evolución de <FONT COLOR="FF4D00">**NIGERIA**</FONT>, en cambio es muy diferente en este país **el virus llega más tarde que los demás** y la **primera ola parece ser mayor que la segunda**, aunque no se pueden tampoco sacar demasiadas conclusiones ya que el sistema sanitario de este país no es comparable al de los otros tres países analizados. 

<FONT COLOR="FF4D00">**JAPÓN**</FONT>, sufre como vemos en el gráfico **tres picos** muy claros. `**El primero, al principio de la pandémia, el siguiente unos meses más tarde y cuando parecia que podian controlar la situación los casos empezaron a aumentar progresivamente** hasta llegar a máximos nunca vistos antes en la pandemia.

Por último, el caso de <FONT COLOR="FF4D00">**ESTADOS UNIDOS**</FONT>
es diferente ya que **la curva es siempre ascendente** y no ofrece cambios extremadamente bruscos como la de los otros países. Su tendencia es clara, **cada vez mas casos teniendo el pico máximo en las fechas más recientes**

<br>

### Continuamos con el análisis a nivel mundial, para ello ahora utilizaremos el paquete **tidycovid19**

```{r echo = TRUE, eval = FALSE}
#remotes::install_github("joachim-gassen/tidycovid19")
library(tidycovid19)

install.packages("maps")
library(lubridate)

merged <- download_merged_data(cached = TRUE, silent = TRUE)

a <- plot_covid19_stripes(
  type = "confirmed",
  countries = c("CHN" , "ESP",  "BRA", "ZAF", "UK", "USA"),
  sort_countries = "countries")

a <- a + theme_test() +  theme(legend.direction = "horizontal") + theme(legend.position = "bottom") +
  labs(title = "COVID-19 -CASOS DIARIOS", subtitle = " Muestra el cambio diario en casos confirmados (promedio de 7 días)", caption = "Datos obtenindos de Johns Hopkins University CSSE Github
  Repo: https://github.com/joachim-gassen/tidycovid19.
       Últimos datos obtenidos 09/12/2020")  
     

a <- a + theme(plot.title = element_text(hjust = 0.5)) +  theme(plot.subtitle = element_text(hjust = 0.5))  

```


```{r eval = TRUE, echo = FALSE, out.width="70%"}
knitr::include_graphics(here::here("imagenes", "barras.png"))
```
<a href="./imagenes/barras.png" target="_blank">[Ampliar Imagen]</a>


En el gráfico anterior se contrasta lo que se ha comentado anteriormente. **El país con más casos diarios actualmente es Estados Unidos**, su tendencia es clara, como se ha dicho antes, no paran de aumentar los casos. Parecida a esta es la tendencia que observamos en Brasil, donde el primer caso se confirmó el 25 de febrero de 2020, en el estado de São Paulo, por parte de un brasileño que viajó a Italia con sintomas leves.

Por otra parte tenemos a **España** y **Sud-Africa**, sus gráficos si muestran las famosas olas donde los casos aumentaban paro luego se reducian. Concretamente en el caso de España se pueden ver como hacia el final, meses más recientes,  vuelven a aparecer tonos mas verdosos lo que significa que los casos han disminuido, en comparación con los meses de marzo-abril.

El país restante es **Chin**a donde según los datos que tenemos la Pandemia esta controlada ya que los valores son infimos para la población que tiene el gigante asiático. Además, se observa que al principio de la crisi sanitaria presentaba más casos que el resto de países analizados (en este gráfico)

<br>

```{r echo = TRUE, eval = FALSE}
mapaCD <- map_covid19(
  data = download_merged_data(cached = TRUE, silent = TRUE),
  type = "deaths",
  cumulative = FALSE,
  change_ave = 7,
  per_capita = TRUE)

library(ggplot2)
mapaCD <- mapaCD + labs(title = "COVID-19",
                        subtitle = "Muestra la variación diaria de muertes por 100.000 habitantes (promedio durante 7 dias)", caption = "Datos del día 07/12/2020,  
Datos obtenindos de Johns Hopkins University CSSE Github Repo: https://github.com/joachim-gassen/tidycovid19.") +
  theme(plot.title = element_text(hjust = 0.5)) +  
  theme(plot.subtitle = element_text(hjust = 0.5))

mapaCD +   scale_fill_viridis_c(direction = -1)
```

```{r eval = TRUE, echo = FALSE, out.width="70%"}
knitr::include_graphics(here::here("imagenes", "Muertes_diarias.png"))
```
<a href="./imagenes/Muertes_diarias.png" target="_blank">[Ampliar Imagen]</a>



```{r echo = TRUE, eval = FALSE}
mapaCC <- map_covid19(
  data = download_merged_data(cached = TRUE, silent = TRUE),
  type = "confirmed",
  cumulative = FALSE,
  change_ave = 7,
  per_capita = TRUE)

mapaCC <- mapaCC + labs(title = "COVID-19 - CASOS CONFIRMADOS",
                        subtitle = "Muestra la variación diaria de casos confirmados por 100.000 habitantes (promedio durante 7 dias)", caption = "Datos del día 07/12/2020,  
Datos obtenindos de Johns Hopkins University CSSE Github Repo: https://github.com/joachim-gassen/tidycovid19.") +
  theme(plot.title = element_text(hjust = 0.5)) +  
  theme(plot.subtitle = element_text(hjust = 0.5))

mapaCC + scale_fill_viridis_c(direction = -1)
```

```{r eval = TRUE, echo = FALSE, out.width="60%"}
knitr::include_graphics(here::here("imagenes", "Casosconfirmados.png"))
```
<a href="./imagenes/Casosconfirmados.png" target="_blank">[Ampliar Imagen]</a>

### 4.4 Evolución de los fallecidos (a nivel mundial)


```{r graficoM}
library(gganimate)
library(plotly)

graficoM <- ggplot(muertes_dia , aes(Dia , Daily_Deaths,  color= Mes))  + geom_line() + 
  labs(title = "Evolución de muertes al día en el mundo por Covid",
    subtitle = "Desde el 24 de Enero hasta el 31 de Octubre", caption = "Elaboración propia con datos 
    del repositorio COVID19",
    y = "Muertes diarias", x = "Dias") +  
  theme(legend.position = "none") + scale_x_continuous(breaks = seq(1, 30, 5)) + 
  facet_wrap(~facet, nrow = 4, ncol = 3)  + transition_reveal(Dia)
```


```{r echo= FALSE, eval = TRUE, out.width="80%"}
graficoM
```

##  5. Conclusiones sobre los "Datos del Mundo". {.tabset}

### <FONT COLOR="FF4D00">**Conclusiones**</FONT>

Mientras que ponemos los gráficos, tablas etc, podemos ir comentando los resultados que hemos obtenido. 

Y aquí poner como las dos o tres ideas más importantes que hemos obtenido al hacer el estudio con los "datos del Mundo" 

### <FONT COLOR="FF4D00">**Live Map**</FONT> 

En este apartado se muestra una bola del mundo dinámica. En ella se recoge el número de muertes, fallecidos y recuperados para cada país, como podemos observar.

Los datos provienen del Centro de ciencia e ingeniería de sistemas (JHU CSSE) de la Universidad Johns Hopkins.

Se actualizan cada día y se obtiene rapidamente gracias a la función **live.map** del paquete: **covid19.analytics**. 

```{r}

library(covid19.analytics)

library(tidyverse)

data <- covid19.data()

data <-data %>%
       select(-c(FIPS,Admin2,Combined_Key)) %>%
       relocate(Lat, .after=Case_Fatality_Ratio) %>%      relocate(Long_, .after=Lat)
```


```{r out.width="100%", eval = TRUE, echo= FALSE}
live.map(data, title = "CORONAVIRUS EN EL MUNDO", no.legend = TRUE)
```




## 6. Estudio sobre los **datos de ESPAÑA**

### 6.1 Datos de interés

<br>
**¿CUÁL FUE LA EVOLUCIÓN DE LOS CONTAGIOS DURANTE LOS 6 PRIMEROS MESES?**


```{r}
#Tabla para poder interpretar el gráfico y consultar más datos

df_mundoE<- df_mundo %>% filter(`Country/Region` == "Spain") %>% select(-c(Recovered, Deaths))

df_mundoEE <- df_mundoE %>% summarise(dif = diff(Confirmed))
dfE <- df_mundoE %>% select(`Country/Region`,Dia, Mes)

df_mundoEsp<- df_mundo %>% filter(`Country/Region` == "Spain") %>% slice(-1)

#Hemos quitados dos de los datos mostrados, ya que distorsionan la gráfica. (Son datos no correctos que contienen valor 0)
Union <- bind_cols(df_mundoEsp, df_mundoEE)
Union <- Union %>% slice(-93)
Union <- Union %>% slice(-115)
Union <- Union %>% slice(-122)
Union <- Union %>% slice(-124)
Union <- Union %>% slice(-50)
Union <- Union %>% mutate(ranking = row_number())

Union <- Union  %>% select(Orden="ranking", Dia, Mes, `Contagios/dia` = "dif", ConfirmadosT="Confirmed", RecuperadosT="Recovered", MuertesT="Deaths")
```


 **TABLA RESUMEN**
```{r}
#En la siguiente tabla se muetra para España el número de contagios al día que hubo en tal fecha y el número de contagios, muertes o recuperados acumulados. Hay que poner una nota de págona diciendo que a partir de julio los fines de semana num de contagios/dia sale como 0)

library(reactable)
reactable(Union, defaultPageSize =  10,  paginationType = "jump", showPageSizeOptions =  TRUE , pageSizeOptions =  c ( 10 , 50 , 100 ),defaultColDef = colDef(
    align = "center",
    minWidth = 70,
    headerStyle = list(background = "lightgreen"),
    filterable = TRUE),  highlight = TRUE, outlined = TRUE,
    columns = list(
  `Contagios/dia` = colDef(style = function(value) {
    if (value > 0) {
      color <- "#e00000"}
      else {
      color <- "#008000"
    }
    list(color = color, fontWeight = "bold")
  })))
```
*Hay que tener en cuenta que a partir de julio los datos en fin de semana tienen un valor de 0, no obstante, deberían obviarse al consultar los datos en la tabla, ya que no resultan coherentes.  

A partir de los datos representados en la tabla anteror, hemos hecho el siguiente gráfico, en él se muestra la evolución de los contagios de Covid en España desde enero hasta junio [^3]

Podemos observar, por tanto,  la "curva" de la <FONT COLOR="FF4D00">**Primera OLA**</FONT>

```{r}
#Gráfico de la evolución de los contagios en España des de enero hasta junio. He cogido estos meses, porque a partir de julio, los datos de los fines de semana son 0, por lo que el gráfico que sale no representa realmente el número de contagios.

df_mundoE<- df_mundo %>% filter(`Country/Region` == "Spain") %>% select(-c(Recovered, Deaths))

df_mundoEE <- df_mundoE %>% summarise(dif = diff(Confirmed))
dfE <- df_mundoE %>% select(`Country/Region`,Dia, Mes)

dfE <- dfE %>% slice(-1)
a <- bind_cols(dfE, df_mundoEE)
b <- a %>% filter(Mes %in% c("01", "02", "03", "04", "05", "06"))

b <- b%>% slice(-93) 
b <- b%>% slice(-115)
b <- b %>% slice(-122)
b <- b %>% slice(-124)
b <- b%>% slice(-50)
b <- b %>% mutate(ranking = row_number())

g6 <- ggplot(b, aes(ranking, dif, color = Mes)) + geom_line() + labs(title = "Evolución contagios Covid-19", subtitle = "De enero a junio (2020)", caption = "Elaboración propia", x = NULL, y = "Nº casos al día") +  theme_bw() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())  +  theme(plot.title = element_text(hjust = 0.5)) + theme(plot.subtitle = element_text(hjust = 0.5))

library(plotly)
```


```{r out.width="100%", out.height="50%", echo=FALSE, eval=TRUE}
ggplotly(g6)
```

<style>
div.blue { background-color:#b1ffa3; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

**Interpretación del gráfico**
En este se muestra la evolución de los contagios por Covid-19 en España durante los 6 primeros meses,los datos van concretamente desde el 23 de enero hasta el 30 de junio,  además se observan 6 colores diferentes, correspondientes a los (6) meses. 
Esta representado de la siguiente manera: En el eje de las ordenadas se meustra el número de casos al día y en el de las abcisas un "ranking", este corresponde a la fila de la tabla representada arriba, en la variable "orden".

**Ejemplo**: __Ranking 59, contagios al día: 3394 y mes 03.__ Para ver a que día corresponde este valor iriamos a la [Tabla Resumen] y vemos que corresponde con el día 22 (de marzo) Además, obtenemos otros datos como el número de confirmados totales hasta ese día, recuperados o muertes.

</div>

### 6.2 Saturación del sistema sanitario español

En este apartado se analizará la **evolución** de los **pacientes  ingresados por Covid durante las últimas 24 horas en los meses de septiembre-octubre y noviembre**. Así como los dados de alta al día, también durante estos meses.

```{r}
datos_CCAA <- datos_CCAA %>%
  relocate(Año, .after=Dia) %>%
  relocate(Mes, .after=Dia)

datos_Esp <- datos_CCAA %>%
  filter(cod_ine == 0) %>%
  relocate(cod_ine, .before=Dia)  #Datos para España.

datos_CV <- datos_CCAA %>%
  filter(cod_ine == 10) %>%
  relocate(cod_ine, .before=Dia) #Datos para la Comunitat Valenciana.

datos_Esp_S_N <- datos_Esp %>% filter (Mes == "09"| Mes == "10"| Mes == "11")

datos_CV_S_N<- datos_CV %>% filter (Mes == "09"| Mes == "10"| Mes == "11")

datos_Esp_N <- datos_Esp %>% filter(Mes == "11")
```

**EVOLUCIÓN DE LOS PACIENTES INGRESADOS POR COVID-19**
```{r}
grafico_1 <- ggplot(datos_Esp_S_N , aes(Dia , `Total Pacientes COVID ingresados`, group=Mes, color= Mes))  + geom_line() + labs(title = " Evolución de pacientes ingresados por covid en España", subtitle = "Desde el 1 Septiembre hasta Noviembre 30", caption = "Datos repositorio COVID19")
```

```{r out.width="70%", echo=FALSE, eval = TRUE}
grafico_1
```


```{r}
grafico_a <- ggplot(datos_Esp_N, aes(Dia, `Altas Ult24h`,   fill = Mes )) +  scale_fill_brewer(palette="Spectral") + geom_bar(stat = "identity")+ 
  labs(title = "Número de pacientes dados de alta por COVID en España al día", subtitle = "Mes Noviembre", caption = "Elaboración propia a partir de datos COVID19") + theme(legend.position = "none")


grafico_ap <- grafico_a + 
  geom_text(aes(y=`Altas Ult24h`, 
    label = `Altas Ult24h`), position = position_dodge(width = 0.8), 
    size = 3.2, vjust=3, col = "Black")
```



```{r out.width="70%", echo = FALSE, eval= TRUE}
grafico_ap
```

```{r}
#Preparamos los datos para hacer una TABLA
datos_CCAA_S_N <- datos_CCAA %>% filter (Mes == "09"| Mes == "10"| Mes == "11")

datos_CCAA_yaltas <- datos_CCAA_S_N %>% mutate(`%Altas por ingresados`  = (`Altas Ult24h`/ `Total Pacientes COVID ingresados`)* 100)

datos_CCAA_yaltas <- datos_CCAA_yaltas %>% select(Dia, Mes, CCAA, `Total Pacientes COVID ingresados`, `% Camas Ocupadas COVID`, `Total pacientes COVID en UCI`, `%Altas por ingresados`)
```

```{r echo = FALSE, eval = TRUE}
DT::datatable(datos_CCAA_yaltas, filter = 'top',
              options = list(pageLength = 10 , autoWidth = TRUE ))
```

## 7. Conclusión




## Referencias

Las siguientes páginas web son las que hemos utilizado para la realización del trabajo:



----------------

<br>

Para acabar este chunk incluiré mi `session info`:

```{r}
sessioninfo::session_info() %>% details::details(summary = 'current session info') 
```

[^1]: Si quieres visitar la web del curso: <a href="https://perezp44.github.io/intro-ds-20-21-web/"target="_blank">https://perezp44.github.io/intro-ds-20-21-web/</a>

[^2]: Si quieres consultar más información haz click <a href="https://www.mscbs.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov/documentos/ITCoronavirus.pdf#:~:text=En%20este%20momento%20se%20desconoce,origen%20de%20la%20pandemia./"target="_blank"> aquí</a> 

[^3]: No hemos hecho la evolución hasta la fecha actual, dado que a partir de julio los datos de contagios en fines de semana muestran unos valores de 0 (Un resultado no coherente)
